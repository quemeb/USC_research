---
title: "AnnoQR2.0"
author: "Bryan Queme"
date: "`r Sys.Date()`"
output: github_document
---

```{r library}
# Try to load AnnoQR
if (!requireNamespace("AnnoQR", quietly = TRUE)) {
  # Check for devtools and install it if necessary
  if (!requireNamespace("devtools", quietly = TRUE)) {
    install.packages("devtools")
  }
  # Load devtools
  library(devtools)
  # Install AnnoQR from GitHub
  devtools::install_github("USCbiostats/AnnoQR")
}

# Load AnnoQR
library(AnnoQR)

```

```{r}
# Only using the basic annotation types
basic_annotations = c("chr", "pos", "ref", "alt",
                      "ANNOVAR_ensembl_Effect",
                      "SnpEff_ensembl_Effect",
                      "SnpEff_ensembl_Effect_impact")
```


```{r, region extraction function}

# Number of hits
hits = function(variants){
  # Finding number of hits
  len = variants$hits$total$value
  
  if(len != 0){
    
    # Creating an empty data frame
    n = length(basic_annotations)
    df = data.frame(matrix(ncol=n, nrow=len))
    
    colnames(df) = basic_annotations
    
    # Filling the data frame with annotation info
    for(i in 1:len){
      for(j in 1:n){
        
        annotation_field <- paste0('_source.', basic_annotations[j])
      
        # Checking for annotations not to be empty
        if(length(variants$hits$hits[[annotation_field]][i]) == 0){
          df[i,j] = " "
        }else{
          df[i,j] = variants$hits$hits[[annotation_field]][i]
        }
      }
    }
    
    return(df)
  }
  
  #else return nothing
}

```

```{r, data intake}
#url <- choose.files()
url <- "https://raw.githubusercontent.com/quemeb/USC_research/main/Kelly/ex_peaks_example.csv"
cdata <- read.csv(url)

```

```{r, multiple regions}

# Length of region file
len_regions = length(cdata$chr)

# Creating an empty data frame
n = length(basic_annotations)
df_all = data.frame(matrix(ncol=n, nrow=0))
names(df_all) <- basic_annotations

for(i in 1:len_regions){
  variants = regionQuery(contig = cdata$chr[i], start = cdata$start[i], end=cdata$end[i])
  x <- hits(variants)
  df_all <- rbind(df_all, x)
}

```

```{r, output table}

write.table(df_all, "ex_peaks.txt", sep = "\t", row.names = FALSE, quote = FALSE)

```


```{r}
x <- regionQuery(contig = '20', start=26188698, end=26190631)
total_count <- x$hits$total$value
```



